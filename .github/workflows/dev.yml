name: CI and Deployment

on:

  push:

    branches: [ develop ]

  pull_request:

    branches: [ develop ]

jobs:

  build:

    runs-on: ubuntu-latest

    steps:

      - name: Environment

        run: |
          cp .env

      - name: Setup Node.js

        uses: actions/setup-node@v2

        with:

          node-version: '16'

 
      - name: Install Node.js Dependencies

        run: npm install


      - name: Build Nuxt

        run: npm run build


  deploy:

    needs: [build]

    runs-on: ubuntu-latest

    steps:

      - name: Checkout code

        uses: actions/checkout@v2

      - name: Setup Environment File

        run: |

          cp .env.example .env

          sed -i 's/DB_USERNAME=root/DB_USERNAME=${{ secrets.DB_USERNAME }}/g' .env

          sed -i 's/DB_PASSWORD=/DB_PASSWORD=${{ secrets.DB_PASSWORD }}/g' .env

          sed -i 's/DB_DATABASE=/DB_DATABASE=${{ secrets.DB_DATABASE }}/g' .env


      - name: Setup Node.js

        uses: actions/setup-node@v2

        with:

          node-version: '16'

 

      - name: Install Node.js Dependencies

        run: npm install

 

      - name: Build Nuxt

        run: npm run build

 

      - name: Clean Up

        run: rm -rf node_modules

 

      - name: copy file via ssh key

        uses: appleboy/scp-action@v0.1.4

        with:

          host: ${{ secrets.SERVER_IP }}

          username: ${{ secrets.SERVER_USERNAME }}

          password: ${{ secrets.PASSWORD }}

          port: 22

          key: ${{ secrets.DEPLOY_KEY }}

          source: "./"

          target: "~/nuxt-express"

 

      - name: Run laravel commands

        uses: appleboy/ssh-action@master

        with:

          host: ${{ secrets.SERVER_IP }}

          username: ${{ secrets.SERVER_USERNAME }}

          key: ${{ secrets.DEPLOY_KEY }}

          port: 22

          script:

            chown -R root ~/nuxt-express && cd ~/nuxt-express && pm2 npm start